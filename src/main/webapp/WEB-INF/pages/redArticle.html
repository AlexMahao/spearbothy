<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>文章查看</title>
	<link rel="stylesheet" type="text/css" href="/css/cssReset.css"/>
	<link rel = "stylesheet" type="text/css" href = "/css/readArticle.css">
	<link rel="stylesheet" href="/css/editormd.css" />

</head>
<body>
	<div class="mheader" >
		<div class="content" >
	 		<h2>茅屋</h2>

	 		<ul>
	 			<li><a href="#">返回</a></li>
	 			<li><a href="#">去首页</a></li>
	 		<ul>
	 	</div>
		
	</div>	

	<div class="maincontent">
		
		<span id="title">给开发者的一份RxJava全解</span>
		<span id="author">作者：<a href="#">任务线</a></span>
	
		<div class="markdown-body editormd-preview-container">
				
<div class="markdown-toc editormd-markdown-toc">[TOC]</div><p>热修复从2015年开始，逐渐的被推广开来，现在已经是比较热门的技术。</p>
<p>当Android发布的Apk中，因为有个bug，导致程序一直崩溃。如果此时发布版本，时间间隔太短，则会导致用户的使用繁琐，导致用户的流逝。而热修复达到的目的便是在不发布版本的情况下，动态修改其中包含bug的类，实现替换，达到修复bug 的目的。</p>
<p>现在市面上有一些开源的热修复，例如androidFix等等。对于这些开源框架不做解释，网上也有类似的文章。在这里，我们从0开始，自己编写脚本与代码实现热修复。</p>
<p>在使用热修复之前，需要一些必备的基础，这些知识是最终结果的铺垫。网上也有一些例子等，但只是一知半解，按照一些例子去最终实现，需要踩很多的坑。别问我为什么知道，我一路踩过来的。。。</p>
<p>本系列文章将分为三篇博客：</p>
<ul>
<li>Android热修复三部曲之基本的Ant打包脚本</li><li>Android热修复三部曲之MultiDex分包架构的实现</li><li>Android热修复三部曲之动态加载dex </li></ul>
<p>该篇博客将给予Eclipse进行设计实现</p>
<h3 id="h3--ant"><a name="什么是Ant" class="reference-link"></a><span class="header-link octicon octicon-link"></span>什么是Ant</h3><p>Ant是一个将软件编译、测试、部署等步骤联系在一起加以自动化的一个工具。而对于Android来说，我们的项目最终打包成Apk，就是通过Ant进行构建的。不过，平常这些工作Eclipse已经帮我们实现了。</p>
<p>在安装的SDK的tools/ant目录下，有默认实现的<code>build.xml</code>文件，如果有兴趣的可以去进行研究，不过代码比较多。</p>
<p>对于Android 中，Ant 最重要的便是编写<code>build.xml</code>文件，该文件确定执行的具体流程，当然，平常我们之所以没有是因为上面提到的缺省的<code>build.xml</code>文件。</p>
<p>既然<code>build.xml</code>确定了编译流程，那么对于一个我们编写好的工程，是怎么最后成我们的apk文件，这个流程我们需要先明确。</p>
<h3 id="h3-android-"><a name="Android 打包流程" class="reference-link"></a><span class="header-link octicon octicon-link"></span>Android 打包流程</h3><p>Android 打包流程主要分为以下几个步骤</p>
<p><strong>1.初始化配置</strong></p>
<p>该配置主要包括删除之前的临时文件，生成临时文件的目录等等。</p>
<p><strong>2.编译生成 R.java文件</strong></p>
<p>Android 中R文件是最重要的java 文件，他沟通了资源文件与java 代码之间的相互调用。</p>
<p>使用SDK中提供的aapt.exe工具，对工程中的资源文件进行编译，生成R文件，aapt.exe位于SDK 目录/build-tools\22.0.1目录下。在这里可能会有疑问，<code>Eclipse</code>中，我们的工程已经自动生成了R文件。但是，这只是<code>Eclipse</code>展示的效果，而实际的工程目录中，并没有R.java 文件的生成。</p>
<p>在这里有一个坑，便是依赖工程的存在。如果我们的工程依赖了别的工程，例如最常见的<code>appcompat_v7</code>,那么生成R.java 时，势必要进行相互的联系，在生成R.java文件时，需要注意。</p>
<p><strong>3.编译工程中的 java 代码</strong></p>
<p>java 基础好的知道，在平常运行中，都会讲.java文件编译为.class 文件，而此步的目的便是将src目录下的.java文件以及R.java 文件，编译成.class文件.</p>
<p>此时注意的是:如果有依赖工程，则依赖工程中的java代码也需要编译。</p>
<p>使用javac 命令</p>
<p><strong>4.对.class 文件进行编译生成.dex文件</strong></p>
<p>如果反编译过apk，会发现里面存在着一个classes.dex文件，该文件便是我们java代码的最终存在形式，此步骤的目的便是将上一步.class 文件整体编译为.dex文件。</p>
<p>使用dx.bat 命令。</p>
<p><strong>5.压缩资源文件</strong></p>
<p>对图片，布局等res文件夹下的资源文件进行压缩，如果反编译apk，会发现总有一个.arsc文件，那边是资源文件。</p>
<p>此时注意的是需要将依赖工程的资源也需要一起压缩。</p>
<p>使用命令 aapt.exe。</p>
<p><strong>6.打出未签名的包</strong></p>
<p>将如上产生的.arsc资源文件与.dex文件一起打包，生成apk文件，此时apk未签名。</p>
<p>在这里，我遇到一个大坑，我以为此时生成的未签名的apk已经能够运行了，但是，运行之后提示解析包出错。实际上，他和Eclipse中生成的未签名包不一样。</p>
<p>apk为什么要签名，我们了解的最多的，一个凭证。安装是会检验是否是正版。但其实，他还有另一层作用，对apk中的文件进行签名，保证资源的不可修改，如果修改之后，需要重新签名。如果没有该步，则会导致解析失败。</p>
<p>通过这可以看出，实际上<code>Eclipse</code>生成的无签名的apk应该也是有签名的，不过不是我们指定的签名而已。（我猜的。。。）</p>
<p>使用命令 apkBuilder ，当然此命令在高版本已删除。我们可以通过另一种方式实现。</p>
<p><strong>7.对Apk进行签名的</strong></p>
<p>这个应该不用多说了，网上也有很多的签名工具。这里通过<code>jarsigner.exe</code>进行签名，该命令是jdk所提供的命令。</p>
<h3 id="h3-ant-"><a name="Ant脚本基础知识" class="reference-link"></a><span class="header-link octicon octicon-link"></span>Ant脚本基础知识</h3><p>在Ant脚本中有两个关键标签</p>
<ul>
<li><code>&lt;project&gt;</code>:跟节点，作为整个工程的基础。</li><li><code>&lt;target&gt;</code>:一个又一个流程。类似上面所说的步骤。</li></ul>
<p>首先，在工程的根目录下：建立<code>build.xml</code>,该目录与清单文件统计，同时添加<code>&lt;project&gt;</code>节点。</p>
<pre><code class="lang-xml">&lt;project
    name=&quot;multiDex&quot;
    default=&quot;a&quot;


    &lt;target name=&quot;b&quot;
        &gt;

    &lt;/target&gt;

    &lt;target name=&quot;a&quot;
        depends=&quot;b&quot;&gt;

    &lt;/target&gt;

&lt;/project&gt;
</code></pre>
<ul>
<li><code>name</code>:此构建脚本的工程名。随便起。</li><li><code>default</code>: 默认执行那个<code>&lt;target&gt;</code></li></ul>
<p>在这里他的实际执行顺序为：</p>
<ul>
<li>先通过<code>project</code>的<code>default</code>属性找到<code>a</code>.</li><li>发现<code>a</code>的执行依赖<code>b</code>,所以找到<code>b</code></li><li>最终，执行<code>b</code>之后执行<code>a</code>。</li></ul>
<h3 id="h3--ant-"><a name="编写Ant 自定义打包流程" class="reference-link"></a><span class="header-link octicon octicon-link"></span>编写Ant 自定义打包流程</h3><p>该流程将按照如上的步骤进行讲解。最后会贴出所有代码。该工程打包时，依赖<code>appcompat_v7</code>库。</p>
<p><strong>1.初始化配置</strong></p>
<pre><code class="lang-xml">   &lt;!-- 代表当前目录 --&gt;
      &lt;property
        name=&quot;project-dir&quot;
        value=&quot;.&quot; /&gt;

      &lt;!-- v7工程目录 --&gt;
      &lt;property
          name=&quot;appcompat-dir&quot;
          value=&quot;D:\eclipse\code\appcompat_v7&quot;/&gt;


    &lt;target name=&quot;init&quot;&gt;
        &lt;!-- 提示信息，类似printf(); --&gt;
        &lt;echo&gt;Init&lt;/echo&gt;
        &lt;!-- 删除文件，创建文件目录 --&gt;
        &lt;delete dir=&quot;${project-dir}\bin&quot;/&gt;
        &lt;delete dir=&quot;${project-dir}\gen&quot;/&gt;
        &lt;mkdir  dir =&quot;${project-dir}\bin&quot;/&gt;
        &lt;mkdir dir = &quot;${project-dir}\gen&quot;/&gt;
        &lt;mkdir dir = &quot;${project-dir}\bin/classes&quot;/&gt;
    &lt;/target&gt;
</code></pre>
<ul>
<li><code>&lt;property&gt;</code>:该节点的作用表示声明一个别名。类似于变量名。</li><li><code>&lt;echo&gt;</code>： 打印提示信息。类似<code>printf()</code>。</li><li><code>&lt;delete&gt;</code> ： 删除文件或文件目录及其下的所有文件。</li><li><code>&lt;mkdir&gt;</code> : 创建文件目录</li></ul>
<p>该步骤，删除之前编译时生成的gen目录（存放R.java）和bin目录（临时文件目录）。并创建新的目录。同时创建<code>bin\classes</code>目录，用以存放后面步骤生成的.class文件。</p>
<p><strong>2.编译生成 R.java文件</strong></p>
<pre><code class="lang-xml"> &lt;!-- 生成R.java 文件。 --&gt;

    &lt;!-- Sdk 的根目录 --&gt;  
    &lt;property
        name=&quot;sdk-folder&quot;
        value=&quot;D:\eclipse\sdk&quot; /&gt;

    &lt;!-- 编译工具的目录 --&gt;  
     &lt;property
        name=&quot;platform-tools-folder&quot;
        value=&quot;${sdk-folder}\build-tools\22.0.1&quot; /&gt;

    &lt;!-- aapt 命令详细的目录 --&gt;
    &lt;property
        name=&quot;tools.aapt&quot;
        value=&quot;${platform-tools-folder}\aapt.exe&quot; /&gt;

    &lt;property
        name=&quot;platform-folder&quot;
        value=&quot;${sdk-folder}\platforms\android-22&quot; /&gt;

    &lt;!-- android.jar 的路径 --&gt;
    &lt;property
        name=&quot;android-jar&quot;
        value=&quot;${platform-folder}\android.jar&quot; /&gt;

     &lt;!-- 当前工程的清单文件 --&gt;
     &lt;property
        name=&quot;manifest&quot;
        value=&quot;${project-dir}\AndroidManifest.xml&quot; /&gt;

    &lt;!-- 依赖库的清单文件 --&gt;
      &lt;property
          name=&quot;appcompat.manifest&quot;
          value=&quot;${appcompat-dir}\AndroidManifest.xml&quot;
          /&gt;

    &lt;target name=&quot;GenR&quot;
        depends=&quot;init&quot;&gt;
        &lt;!-- 生成工程的R.java 文件 --&gt;
        &lt;echo&gt;gen project  R.java &lt;/echo&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-m&quot;/&gt;
            &lt;arg value = &quot;-J&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\gen&quot;/&gt;
            &lt;arg value = &quot;-M&quot;/&gt;
            &lt;arg value=&quot;${manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;          
        &lt;/exec&gt;
         &lt;!-- 生成依赖库的R.java 文件 --&gt;
         &lt;echo&gt;gen appcompat  R.java &lt;/echo&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-m&quot;/&gt;
            &lt;arg value = &quot;-J&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\gen&quot;/&gt;
            &lt;arg value = &quot;-M&quot;/&gt;
            &lt;arg value=&quot;${appcompat.manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;          
        &lt;/exec&gt;
    &lt;/target&gt;
</code></pre>
<p>在执行命令时：按照顺许分别代表的意思：</p>
<ul>
<li><code>-m</code>:使生成的包的目录存放在<code>-J</code>参数指定的目录</li><li><code>-J</code>:指定生成的.java 存放的目录.</li><li><code>-M</code>:指定清单文件的路径，之所以需要清单文件的目的是为了获取到包名。</li><li><code>-S</code>：res存放的目录。</li><li><code>-I</code>：某个版本平台的android.jar的路径</li><li><code>--auto-add-overlay</code>：覆盖资源，必须加上。</li></ul>
<p>可以看到，分别对工程和依赖库进行编译。因为工程依赖了v7库，两者中资源有调用，所以在添加<code>res</code>存放的目录时，必须都添加。</p>
<p><strong>3.编译工程中的 java 代码</strong></p>
<p>上一步中，在bin目录中生成了R.java 文件。此步便是生成.class 文件保存到bin/classes目录中。</p>
<pre><code class="lang-xml">   &lt;!-- 编译工程中的src 中的代码
            因为我配置了java 环境变量，所以直接使用了javac
     --&gt;
      &lt;target name=&quot;compile&quot; 
        depends=&quot;GenR&quot;
        &gt;
         &lt;echo&gt;Compiling java source code...&lt;/echo&gt;
         &lt;!-- 编译依赖库的java文件 --&gt;
         &lt;javac encoding=&quot;UTF-8&quot; destdir=&quot;${project-dir}/bin/classes&quot; bootclasspath=&quot;${android-jar}&quot;&gt;
             &lt;src path=&quot;${appcompat-dir}/src&quot;/&gt;
             &lt;src path=&quot;gen&quot;/&gt;
             &lt;classpath&gt;
                &lt;fileset dir=&quot;${appcompat-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;             
         &lt;/javac&gt;

         &lt;!-- 编译工程的java文件 --&gt;
         &lt;javac encoding=&quot;UTF-8&quot; destdir=&quot;${project-dir}/bin/classes&quot; bootclasspath=&quot;${android-jar}&quot;&gt;
             &lt;src path=&quot;${project-dir}/src&quot;/&gt;
             &lt;src path=&quot;gen&quot;/&gt;
             &lt;classpath&gt;
                &lt;fileset dir=&quot;${project-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;  
            &lt;classpath&gt;
                &lt;fileset dir=&quot;${appcompat-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;           
         &lt;/javac&gt;
    &lt;/target&gt;
</code></pre>
<p>挑几个重点说： </p>
<p><code>destdir</code>：生成的.class的存放目录,保存在当前工程目录下bin/classes 目录下。</p>
<p>需要对依赖库和当前工程分别编译，生成.class文件。</p>
<p><code>&lt;classpath&gt;</code>中包含了编译时需要的一些jar包，因为jar包后面可以直接打入.dex中，所以在此时作为一个辅助编译的作用。</p>
<p>对于当前工程，编译时也需要依赖<code>appcompat_v7</code>中的jar包，因为使用到了里面的类。</p>
<p><strong>4.对.class 文件进行编译生成.dex文件</strong></p>
<pre><code class="lang-xml">   &lt;!-- 将工程中的源码打成dex --&gt;

     &lt;property
        name=&quot;tools.dx&quot;
        value=&quot;${platform-tools-folder}\dx.bat&quot; /&gt;

    &lt;target name=&quot;dex&quot; depends=&quot;compile&quot;&gt;
        &lt;echo&gt; build dex&lt;/echo&gt;
        &lt;exec executable=&quot;${tools.dx}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;--dex&quot;/&gt;
            &lt;arg value=&quot;--output=${project-dir}/bin/classes.dex&quot;/&gt;
            &lt;arg value=&quot;${project-dir}/bin/classes&quot;/&gt;
            &lt;arg value=&quot;${project-dir}/libs&quot;/&gt;
             &lt;arg value=&quot;${appcompat-dir}/libs&quot;/&gt;
        &lt;/exec&gt;

    &lt;/target&gt;
</code></pre>
<p>将bin/classes，工程的jar，依赖库的jar统一打到bin/classes.dex中。</p>
<p><strong>5.压缩资源文件</strong></p>
<pre><code class="lang-xml"> &lt;!--  打包资源文件 --&gt;
    &lt;target name=&quot;build-res-and-assets&quot;
        depends=&quot;dex&quot;
        &gt;
        &lt;echo&gt; build-res-and-assets &lt;/echo&gt;
        &lt;!-- 打包资源文件 --&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-f&quot;/&gt; &lt;!--  资源覆盖重写 --&gt;
            &lt;arg value=&quot;-M&quot;/&gt; &lt;!-- 指定清单文件 --&gt;
            &lt;arg value=&quot;${manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt; &lt;!-- 指定资源路径 --&gt;
            &lt;arg value=&quot;res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}/res&quot;/&gt;
            &lt;arg value=&quot;-A&quot;/&gt;
            &lt;arg value=&quot;assets&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;-F&quot; /&gt;&lt;!-- 输出资源压缩包 --&gt;
            &lt;arg value=&quot;${project-dir}/bin/resources.arsc&quot; /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;     
        &lt;/exec&gt;
    &lt;/target&gt;
</code></pre>
<p>将工程和依赖库中的<code>res</code>，<code>assets</code>文件统一压缩到<code>bin/resources.arsc</code>中。</p>
<p><strong>6.打出未签名的包</strong></p>
<pre><code class="lang-xml"> &lt;!-- 打包 --&gt;
    &lt;target
        name=&quot;package&quot; depends=&quot;build-res-and-assets&quot;
        &gt;
        &lt;echo&gt; package unsign  &lt;/echo&gt;
          &lt;java
            classname=&quot;com.android.sdklib.build.ApkBuilderMain&quot;
            classpath=&quot;${sdk-folder}/tools/lib/sdklib.jar&quot; &gt;

            &lt;arg value=&quot;${project-dir}/bin/unsign.apk&quot; /&gt; &lt;!-- 未签名apk的生成路径  --&gt;

            &lt;arg value=&quot;-u&quot; /&gt; &lt;!-- 创建一个未签名的包 --&gt;

            &lt;arg value=&quot;-z&quot; /&gt;  &lt;!-- 需要添加的压缩包 --&gt;

            &lt;arg value=&quot;${project-dir}/bin/resources.arsc&quot; /&gt;

            &lt;arg value=&quot;-f&quot; /&gt; &lt;!-- 需要添加的文件--&gt;

            &lt;arg value=&quot;bin/classes.dex&quot; /&gt;
        &lt;/java&gt;

    &lt;/target&gt;
</code></pre>
<p>打成的包是未签名的包。他和最终的apk的唯一区别，通过解压会发现未签名的包中没有<code>META-INF</code>文件，该文件主要负责解析，以及文件的完整性等。</p>
<p><strong>7.对Apk进行签名的</strong></p>
<pre><code class="lang-xml">    &lt;!-- jdk 路径 --&gt;
      &lt;property
        name=&quot;jdk-folder&quot;
        value=&quot;C:\Program Files\Java\jdk1.7.0_79&quot; /&gt;
      &lt;!-- 签名文件路径 --&gt;
      &lt;property
        name=&quot;tools.jarsigner&quot;
        value=&quot;${jdk-folder}\bin\jarsigner.exe&quot; /&gt;

    &lt;target
        name=&quot;sign-apk&quot;
        depends=&quot;package&quot; &gt;
        &lt;echo&gt;
              Sign apk
        &lt;/echo&gt;
        &lt;exec
            executable=&quot;${tools.jarsigner}&quot;
            failonerror=&quot;true&quot; &gt;
            &lt;arg value=&quot;-keystore&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/my.keystore&quot; /&gt;
            &lt;arg value=&quot;-storepass&quot; /&gt;
            &lt;arg value=&quot;123456&quot; /&gt; &lt;!--仓库密码  --&gt;
            &lt;arg value=&quot;-keypass&quot; /&gt;
            &lt;arg value=&quot;123456&quot; /&gt; &lt;!-- 秘钥的密码 --&gt;
            &lt;arg value=&quot;-signedjar&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/bin/sign.apk&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/bin/unsign.apk&quot; /&gt;
            &lt;arg value=&quot;ant_test&quot; /&gt; &lt;!-- 秘钥的别名 --&gt;
        &lt;/exec&gt;
    &lt;/target&gt;
</code></pre>
<h3 id="h3--ant-"><a name="完整的Ant 编译脚本代码" class="reference-link"></a><span class="header-link octicon octicon-link"></span>完整的Ant 编译脚本代码</h3><pre><code class="lang-xml">
&lt;project
    name=&quot;multiDex&quot;
    default=&quot;sign-apk&quot;
    &gt;
      &lt;!-- 代表当前目录 --&gt;
      &lt;property
        name=&quot;project-dir&quot;
        value=&quot;.&quot; /&gt;

      &lt;!-- v7工程目录 --&gt;
      &lt;property
          name=&quot;appcompat-dir&quot;
          value=&quot;D:\eclipse\code\appcompat_v7&quot;/&gt;


    &lt;target name=&quot;init&quot;&gt;
        &lt;!-- 提示信息，类似printf(); --&gt;
        &lt;echo&gt;Init&lt;/echo&gt;
        &lt;!-- 删除文件，创建文件目录 --&gt;
        &lt;delete dir=&quot;${project-dir}\bin&quot;/&gt;
        &lt;delete dir=&quot;${project-dir}\gen&quot;/&gt;
        &lt;mkdir  dir =&quot;${project-dir}\bin&quot;/&gt;
        &lt;mkdir dir = &quot;${project-dir}\gen&quot;/&gt;
        &lt;mkdir dir = &quot;${project-dir}\bin/classes&quot;/&gt;
    &lt;/target&gt;

    &lt;!-- 生成R.java 文件。 --&gt;

    &lt;!-- Sdk 的根目录 --&gt;  
    &lt;property
        name=&quot;sdk-folder&quot;
        value=&quot;D:\eclipse\sdk&quot; /&gt;

    &lt;!-- 编译工具的目录 --&gt;  
     &lt;property
        name=&quot;platform-tools-folder&quot;
        value=&quot;${sdk-folder}\build-tools\22.0.1&quot; /&gt;

    &lt;!-- aapt 命令详细的目录 --&gt;
    &lt;property
        name=&quot;tools.aapt&quot;
        value=&quot;${platform-tools-folder}\aapt.exe&quot; /&gt;

    &lt;property
        name=&quot;platform-folder&quot;
        value=&quot;${sdk-folder}\platforms\android-22&quot; /&gt;

    &lt;!-- android.jar 的路径 --&gt;
    &lt;property
        name=&quot;android-jar&quot;
        value=&quot;${platform-folder}\android.jar&quot; /&gt;

     &lt;!-- 当前工程的清单文件 --&gt;
     &lt;property
        name=&quot;manifest&quot;
        value=&quot;${project-dir}\AndroidManifest.xml&quot; /&gt;

     &lt;!-- 依赖库的清单文件 --&gt;
      &lt;property
          name=&quot;appcompat.manifest&quot;
          value=&quot;${appcompat-dir}\AndroidManifest.xml&quot;
          /&gt;

    &lt;target name=&quot;GenR&quot;
        depends=&quot;init&quot;&gt;
        &lt;!-- 生成工程的R.java 文件 --&gt;
        &lt;echo&gt;gen project  R.java &lt;/echo&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-m&quot;/&gt;
            &lt;arg value = &quot;-J&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\gen&quot;/&gt;
            &lt;arg value = &quot;-M&quot;/&gt;
            &lt;arg value=&quot;${manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;          
        &lt;/exec&gt;
         &lt;!-- 生成依赖库的R.java 文件 --&gt;
         &lt;echo&gt;gen appcompat  R.java &lt;/echo&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-m&quot;/&gt;
            &lt;arg value = &quot;-J&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\gen&quot;/&gt;
            &lt;arg value = &quot;-M&quot;/&gt;
            &lt;arg value=&quot;${appcompat.manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${project-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}\res&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;          
        &lt;/exec&gt;
    &lt;/target&gt;

    &lt;!-- 编译工程中的src 中的代码
            因为我配置了java 环境变量，所以直接使用了javac
     --&gt;
    &lt;target name=&quot;compile&quot; 
        depends=&quot;GenR&quot;
        &gt;
         &lt;echo&gt;Compiling java source code...&lt;/echo&gt;
         &lt;!-- 编译依赖库的java文件 --&gt;
         &lt;javac encoding=&quot;UTF-8&quot; destdir=&quot;${project-dir}/bin/classes&quot; bootclasspath=&quot;${android-jar}&quot;&gt;
             &lt;src path=&quot;${appcompat-dir}/src&quot;/&gt;
             &lt;src path=&quot;gen&quot;/&gt;
             &lt;classpath&gt;
                &lt;fileset dir=&quot;${appcompat-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;             
         &lt;/javac&gt;

         &lt;!-- 编译工程的java文件 --&gt;
         &lt;javac encoding=&quot;UTF-8&quot; destdir=&quot;${project-dir}/bin/classes&quot; bootclasspath=&quot;${android-jar}&quot;&gt;
             &lt;src path=&quot;${project-dir}/src&quot;/&gt;
             &lt;src path=&quot;gen&quot;/&gt;
             &lt;classpath&gt;
                &lt;fileset dir=&quot;${project-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;  
            &lt;classpath&gt;
                &lt;fileset dir=&quot;${appcompat-dir}/libs&quot; includes=&quot;*.jar&quot; /&gt;&lt;!-- 第三方jar包需要引用，用于辅助编译 --&gt;
            &lt;/classpath&gt;           
         &lt;/javac&gt;
    &lt;/target&gt;

    &lt;!-- 将工程中的源码打成dex --&gt;

     &lt;property
        name=&quot;tools.dx&quot;
        value=&quot;${platform-tools-folder}\dx.bat&quot; /&gt;

    &lt;target name=&quot;dex&quot; depends=&quot;compile&quot;&gt;
        &lt;echo&gt; build dex&lt;/echo&gt;
        &lt;exec executable=&quot;${tools.dx}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;--dex&quot;/&gt;
            &lt;arg value=&quot;--output=${project-dir}/bin/classes.dex&quot;/&gt;
            &lt;arg value=&quot;${project-dir}/bin/classes&quot;/&gt;
            &lt;arg value=&quot;${project-dir}/libs&quot;/&gt;
             &lt;arg value=&quot;${appcompat-dir}/libs&quot;/&gt;
        &lt;/exec&gt;

    &lt;/target&gt;

    &lt;!--  打包资源文件 --&gt;
    &lt;target name=&quot;build-res-and-assets&quot;
        depends=&quot;dex&quot;
        &gt;
        &lt;echo&gt; build-res-and-assets &lt;/echo&gt;
        &lt;!-- 打包资源文件 --&gt;
        &lt;exec executable=&quot;${tools.aapt}&quot; failonerror=&quot;true&quot;&gt;
            &lt;arg value=&quot;package&quot;/&gt;
            &lt;arg value=&quot;-f&quot;/&gt; &lt;!--  资源覆盖重写 --&gt;
            &lt;arg value=&quot;-M&quot;/&gt; &lt;!-- 指定清单文件 --&gt;
            &lt;arg value=&quot;${manifest}&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt; &lt;!-- 指定资源路径 --&gt;
            &lt;arg value=&quot;res&quot;/&gt;
            &lt;arg value=&quot;-S&quot;/&gt;
            &lt;arg value=&quot;${appcompat-dir}/res&quot;/&gt;
            &lt;arg value=&quot;-A&quot;/&gt;
            &lt;arg value=&quot;assets&quot;/&gt;
            &lt;arg value=&quot;-I&quot;/&gt;
            &lt;arg value=&quot;${android-jar}&quot;  /&gt;
            &lt;arg value=&quot;-F&quot; /&gt;&lt;!-- 输出资源压缩包 --&gt;
            &lt;arg value=&quot;${project-dir}/bin/resources.arsc&quot; /&gt;
            &lt;arg value=&quot;--auto-add-overlay&quot;/&gt;     
        &lt;/exec&gt;
    &lt;/target&gt;

    &lt;!-- 打包 --&gt;
    &lt;target
        name=&quot;package&quot; depends=&quot;build-res-and-assets&quot;
        &gt;
        &lt;echo&gt; package unsign  &lt;/echo&gt;
          &lt;java
            classname=&quot;com.android.sdklib.build.ApkBuilderMain&quot;
            classpath=&quot;${sdk-folder}/tools/lib/sdklib.jar&quot; &gt;

            &lt;arg value=&quot;${project-dir}/bin/unsign.apk&quot; /&gt; &lt;!-- 未签名apk的生成路径  --&gt;

            &lt;arg value=&quot;-u&quot; /&gt; &lt;!-- 创建一个未签名的包 --&gt;

            &lt;arg value=&quot;-z&quot; /&gt;  &lt;!-- 需要添加的压缩包 --&gt;

            &lt;arg value=&quot;${project-dir}/bin/resources.arsc&quot; /&gt;

            &lt;arg value=&quot;-f&quot; /&gt; &lt;!-- 需要添加的文件--&gt;

            &lt;arg value=&quot;bin/classes.dex&quot; /&gt;
        &lt;/java&gt;

    &lt;/target&gt;


      &lt;!-- jdk 路径 --&gt;
      &lt;property
        name=&quot;jdk-folder&quot;
        value=&quot;C:\Program Files\Java\jdk1.7.0_79&quot; /&gt;
      &lt;!-- 签名文件路径 --&gt;
      &lt;property
        name=&quot;tools.jarsigner&quot;
        value=&quot;${jdk-folder}\bin\jarsigner.exe&quot; /&gt;

    &lt;target
        name=&quot;sign-apk&quot;
        depends=&quot;package&quot; &gt;
        &lt;echo&gt;
              Sign apk
        &lt;/echo&gt;
        &lt;exec
            executable=&quot;${tools.jarsigner}&quot;
            failonerror=&quot;true&quot; &gt;
            &lt;arg value=&quot;-keystore&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/my.keystore&quot; /&gt;
            &lt;arg value=&quot;-storepass&quot; /&gt;
            &lt;arg value=&quot;123456&quot; /&gt; &lt;!--仓库密码  --&gt;
            &lt;arg value=&quot;-keypass&quot; /&gt;
            &lt;arg value=&quot;123456&quot; /&gt; &lt;!-- 秘钥的密码 --&gt;
            &lt;arg value=&quot;-signedjar&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/bin/sign.apk&quot; /&gt;
            &lt;arg value=&quot;${project-dir}/bin/unsign.apk&quot; /&gt;
            &lt;arg value=&quot;ant_test&quot; /&gt; &lt;!-- 秘钥的别名 --&gt;
        &lt;/exec&gt;
    &lt;/target&gt;
&lt;/project&gt;
</code></pre>


				
		</div>
</div>

</body>
</html>